# 2023/05/29

## 명령어 병렬 처리 기법

CPU를 빠르게 처리할수 있도록 설계하는것도 중요하지만
CPU가 시간 낭비 없이 메모리에 있는 명령어들을 실행하게 하는 것도 중요하다


### 명령어 파이프라인

하나의 명령어가 처리되는 과정을 비슷한 시간 간격으로 나눈다면, 크게

1. 명령어 인출
2. 명령어 해석
3. 명령어 실행
4. 결과 저장

으로 나눌 수 있다

CPU는 같은 단계가 겹치지 않는다면, 각 단계를 동시에 실행할 수 있다.
A명령어를 인출 후 해석 중이라면 B 명령어를 인출 해 오는 식으로 작업을 진행할 수 있다는 것이다

이런 식으로 명령어를 병렬로 처리하는 방식을 명령어 파이프라인 이라고 부른다


#### 파이프라인 위험

명령어 파이프라인이 성능 향상에 실패하는 경우가 있는데

크게 아래 세 가지로 나뉜다

1. 데이터 위험

명령어 간의 의존성
모든 명령어를 동시에 처리할 수는 없다, 이전 명령어를 끝까지 실행해야만 실행할 수 있는 경우

2. 제어 위험

프로그램 카운터의 갑작스러운 변화
JUMP, CALL 등의 명령어로 프로그램 카운터가 급격하게 변하는 경우
기본적으로 명령어는 순차적으로 가져오고 해석한다

예를 들어 10 → 11 → 12 처럼 순차적으로 해석되어야 하는 명령어가.
10번지 명령어에서 60번지 명령어로 가야 한다면, 11번지와 12번지의 작업은 할 필요가 없기 때문이다

다만, 이러한 상황을 방지하기 위해, 프로그램 카운터가 다음 주소를 미리 예측하는 기술이 있는데, 이것을 분기 예측 ( Branch prediction ) 이라고 한다

3. 구조적 위험

서로 다른 명령어가 같은 CPU부품을 사용하려고 할 때
A명령어와 B명령어가 동시에 ALU나 특정 레지스터를 사용하려고 한다면, 동시에 접근할 수 없기 때문에 병렬로 작업을 진행 할 수가 없다


#### 슈퍼스칼라

CPU 내부에 여러 개의 명령어 파이프라인을 포함한 구조
오늘날의 멀티스레드 프로세서

이론적으로는 파이프라인 개수에 비례하여 처리 속도가 증가해야 하지만
동시에 처리하는 명령어의 숫자가 증가하면서, 파이프라인 위험도도 같이 증가하기 때문에, 항상 파이프라인 개수에 비례해서 처리 속도가 증가하진 않는다


### 비순차적 명령어 처리

비순차적 명령어 처리란, 파이프라인의 중단을 방지하기 위해서 명령어를 순차적으로 처리하지 않는 명령어 병렬 처리 기법이다

파이프라인 위험이 있을 때, 대기해야 하는 명령어 사이에 의존성이 없는 다른 명령어를 끼워넣어 먼저 실행하는 명령어 처리 방법이다

다만 아무 명령어나 사이에 끼워넣거나 순서를 바꿀 수는 없다, 순서의 바꾸어도 프로그램의 실행 결과에 영향이 없는 경우에만 가능하다.

